---
title: "Final Project"
author: "楊博儒"
output: html_document
---

# PTT 蔡英文網路討論聲量預測

本次報告希望針對提到蔡英文的 PTT 文章進分析，並且透過文章分類的方式來預測蔡英文的網路討論聲量。

```{r}
options(stringsAsFactors = FALSE)
library(tidyverse)
library(topicmodels)
library(tidytext)
library(jiebaR)
library(LDAvis)
library(servr)
library(e1071)
```

### 載入資料

```{r}
load("Ptt_gos_2_3_post.rda")
load("Ptt_gos_2_3_reply.rda")
apr_data <- read_csv("April_Gossiping_Data.csv")
jan_post <- read.csv("1月/res.csv")
jan_reply <- read.csv("1月/push_all.csv")
load("may_link.rda")
load("may_post.rda")
load("may_reply.rda")
```

### 資料清理

```{r}
jan_post <- jan_post %>%
  select(Date, Content, Link) %>%
  mutate(Date = as.Date(Date)) %>%
  filter(between(Date, as.Date("2019-01-01"), as.Date("2019-01-31"))) %>%
  rename(time = "Date", post = "Content", url = "Link")

jan_reply <- jan_reply %>%
  select(X, Link) %>%
  rename(rowid = "X", url = "Link") %>%
  group_by(url) %>%
  top_n(1, rowid)

feb_mar_post <- Ptt_gos_2_3_post %>%
  select(time, post, url) %>%
  mutate(time = as.Date(.$time, format = "%m/%d"))

feb_mar_reply <- Ptt_gos_2_3_reply %>%
  select(rowid, url) %>%
  group_by(url) %>%
  top_n(1, rowid)

apr_post <- apr_data %>%
  select(Date, Content, Link) %>%
  rename(time = "Date", post = "Content", url = "Link") %>%
  mutate(time = as.Date(.$time, format = "%m/%d")) %>%
  filter(between(time, as.Date("2019-04-01"), as.Date("2019-04-30")))

apr_reply <- apr_data %>%
  select(Push_Count, Link) %>%
  rename(rowid = "Push_Count", url = "Link")

train_post <- bind_rows(jan_post, feb_mar_post, apr_post)
train_reply <- bind_rows(jan_reply, feb_mar_reply, apr_reply)

train_post <- train_post %>%
  mutate(doc_id = row_number()) %>%
  mutate(doc_id = as.character(doc_id))
```

### 載入斷詞

```{r}
segment_not <- c("蔡英文", "蔡總統",  "韓國瑜", "柯文哲", "柯市長", "柯p", "韓市長", "九二共識", "空污", "高雄", "韓粉", "喜韓兒", "藍蛆", "綠吱", "時代力量", "舔共", "假新聞", "笑死", "歐陽娜娜", "爆料公社", "核電", "劈腿", "非洲豬瘟", "屏東燈會")
stopWords <- readRDS("stopWords.rds")
stopWords <- rbind(stopWords, data.frame(word = c("1.", "2.", "from", "my", "Sent", "JPTT", "完整", "連結", "網址", "內文", "備註", "來源", "3.", "4.", "5.", "新聞標題", "約", "達", "占", "G", "the", "a", "to", "in", "I", "and", "of", "s", "is", "you", "IPhone", "Asus", "ASUS", "Samsung", "SM", "Sony", "HTC", "u", "Xiaomi", "新聞")))

jieba <- worker()
new_user_word(jieba, segment_not)
```

### 內文斷詞

```{r}
train_post_tokenized <- train_post %>%
  select(post, doc_id) %>%
  mutate(word = purrr::map(post, function(x) segment(x, jieba))) %>%
  unnest(word) %>%
  anti_join(stopWords) %>%
  mutate(word = gsub("[A-Za-z0-9.]", "", word)) %>%
  filter(nchar(word) > 1) %>% 
  count(doc_id, word, sort = TRUE)
```

### 蔡英文一月到四月網路討論討論聲量圖

創造討論聲量的指標，以每一天為單位，以一天的相關文章的總回覆數量除以相關文章的總篇數為指標。

```{r}
train_post_tsai <- train_post_tokenized %>%
  filter(word %in% c("蔡英文", "蔡總統")) %>%
  left_join(train_post, by = "doc_id") %>%
  distinct(doc_id, .keep_all = TRUE)

index_tsai <- train_post_tsai %>% 
  select(url, time) %>%
  left_join(train_reply, by = "url") %>%
  filter(!is.na(rowid)) %>%
  group_by(time) %>%
  mutate(reply_sum = sum(rowid)) %>%
  count(time, reply_sum) %>%
  mutate(index = reply_sum / n)

ggplot(index_tsai) +
  aes(x = time, y = index) +
  geom_line() +
  xlab("month") +
  ggtitle("index of tsai from Jan to May") +
  theme(text = element_text(family = "PingFangTC-Medium"))
```

### 主題模型

```{r}
train_tsai_tokenized <- train_post_tokenized %>%
  filter(doc_id %in% train_post_tsai$doc_id)

lda_train_tsai <- train_tsai_tokenized %>% cast_dtm(doc_id, word, n)

ldaOut <- LDA(lda_train_tsai, 6, method = "Gibbs", control = list(seed = 1234))

topicmodels2LDAvis <- function(x, ...){
    post <- topicmodels::posterior(x)
    if (ncol(post[["topics"]]) < 3) stop("The model must contain > 2 topics")
    mat <- x@wordassignments
    LDAvis::createJSON(
        phi = post[["terms"]], 
        theta = post[["topics"]],
        vocab = colnames(post[["terms"]]),
        doc.length = slam::row_sums(mat, na.rm = TRUE),
        term.frequency = slam::col_sums(mat, na.rm = TRUE)
    )
}

lda.json <- topicmodels2LDAvis(ldaOut)
serVis(lda.json)
```

### 主題分類

根據主題模型將文章分類，並且找出了六種主題，兩岸議題、價值宣傳、內政事務、一般性討論、選舉事務、韓國瑜。

```{r}
topic_distribution <- tidy(ldaOut, matrix = "gamma")

topic_classification <- topic_distribution %>%
  group_by(document) %>%
  top_n(1, gamma) %>%
  filter(gamma > 0.3) %>%
  ungroup()

topic_classification <- 
  topic_classification[!duplicated(topic_classification$document), ]

colnames(topic_classification)[1] <- "doc_id"

post_with_topic <- topic_classification %>%
  select(-gamma) %>%
  left_join(train_post_tsai, by = "doc_id") %>%
  mutate(topic_name = ifelse(topic == 1, "兩岸議題",
                             ifelse(topic == 2, "價值宣傳",
                              ifelse(topic == 3, "內政事務",
                              ifelse(topic == 4, "一般性討論",
                              ifelse(topic == 5, "選舉事務", "韓國瑜"))))))
```

### 以一月到四月資料作為訓練資料，建立預測模型

透過分析這六種主題對於總體聲量的影響權重，並且透過 SVR 來建立預測模型。

```{r}
index_topic <- post_with_topic %>%
  select(doc_id, topic_name, url, time) %>%
  left_join(train_reply, by = "url") %>%
  group_by(time, topic_name) %>% 
  mutate(reply_sum = sum(rowid)) %>%
  count(time, reply_sum) %>%
  mutate(index = reply_sum / n) %>%
  spread(topic_name, index, fill = 0) %>%
  group_by(time) %>%
  summarise(選舉事務 = sum(選舉事務),
            兩岸議題 = sum(兩岸議題),
            韓國瑜 = sum(韓國瑜),
            價值宣傳 = sum(價值宣傳),
            內政事務 = sum(內政事務),
            一般性討論 = sum(一般性討論)) %>%
  left_join(index_tsai, by = "time")

model <- svm(index ~ 選舉事務 + 兩岸議題 + 韓國瑜 + 價值宣傳 + 內政事務 + 一般性討論, data = index_topic)
summary(model)
```

### 引進五月資料作為測試資料

```{r}
test_data_post <- links.df %>%
  left_join(post.df, by = "url") %>%
  select(time, post, url) %>%
  mutate(time = as.Date(.$time, format = "%m/%d")) %>%
  filter(between(time, as.Date("2019-05-01"), as.Date("2019-05-31"))) %>%
  mutate(doc_id = row_number()) %>%
  mutate(doc_id = as.character(doc_id))
```

### 測試資料前處理

```{r}
test_data_post_tokenized <- test_data_post %>%
  select(post, doc_id) %>%
  mutate(word = purrr::map(post, function(x) segment(x, jieba))) %>%
  unnest(word) %>%
  anti_join(stopWords) %>%
  mutate(word = gsub("[A-Za-z0-9.]", "", word)) %>%
  filter(nchar(word) > 1) %>% 
  count(doc_id, word, sort = TRUE)

test_data_tsai <- test_data_post_tokenized %>%
  filter(word %in% c("蔡英文", "蔡總統")) %>%
  left_join(test_data_post, by = "doc_id") %>%
  distinct(doc_id, .keep_all = TRUE)

test_data_topic <- test_data_post_tokenized %>%
  filter(doc_id %in% test_data_tsai$doc_id) %>%
  filter(word %in% terms(ldaOut, 30)) %>%
  mutate(兩岸議題 = ifelse(word %in% terms(ldaOut, 30)[,1], n, 0),
        價值宣傳 = ifelse(word %in% terms(ldaOut, 30)[,2], n, 0),
        內政事務 = ifelse(word %in% terms(ldaOut, 30)[,3], n, 0),
        一般性討論 = ifelse(word %in% terms(ldaOut, 30)[,4], n, 0),
        選舉事務 = ifelse(word %in% terms(ldaOut, 30)[,5], n, 0),
        韓國瑜 = ifelse(word %in% terms(ldaOut, 30)[,6], n, 0)) %>%
  group_by(doc_id) %>%
  mutate(兩岸議題 = sum(兩岸議題),
        價值宣傳 = sum(價值宣傳),
        內政事務 = sum(內政事務),
        一般性討論 = sum(一般性討論),
        選舉事務 = sum(選舉事務),
        韓國瑜 = sum(韓國瑜)) %>%
  distinct(doc_id, .keep_all = TRUE) %>%
  select(-n, -word) %>%
  gather(topic_name, "index", 2:7) %>%
  top_n(1, index) %>%
  distinct(doc_id, .keep_all = TRUE) %>%
  filter(index > 2)
```

### 得出預測值

```{r}
data_pred <- test_data_topic %>%
  left_join(test_data_post, by = "doc_id") %>%
  select(doc_id, topic_name, time, url) %>%
  left_join(reply.df, by = "url") %>%
  group_by(doc_id) %>%
  top_n(1, rowid) %>%
  group_by(time, topic_name) %>%
  mutate(reply_sum = sum(rowid)) %>%
  count(time, reply_sum) %>%
  mutate(index = reply_sum / n) %>%
  spread(topic_name, index, fill = 0) %>%
  group_by(time) %>%
  summarise(兩岸議題 = sum(兩岸議題),
            內政事務 = sum(內政事務),
            韓國瑜 = sum(韓國瑜),
            價值宣傳 = sum(價值宣傳),
            一般性討論 = sum(一般性討論),
            選舉事務 = sum(選舉事務))

pred_index <- predict(model, data_pred)
```

### 找出真實值

```{r}
real_index <- test_data_tsai %>%
  left_join(reply.df, by = "url") %>% 
  group_by(doc_id) %>%
  top_n(1, rowid) %>% 
  group_by(time) %>%
  mutate(reply_sum = sum(rowid)) %>% 
  count(time, reply_sum) %>% 
  mutate(index = reply_sum / nn)
```

### 預測結果

藍色為實際值，紅色為預測值，預測的值普遍比實際值稍低一些，並且相對保守許多，但大致的變動方向都有捕捉到。

```{r}
pred_data <- data.frame(pred_index, real_index$time)

ggplot() +
  geom_line(data = real_index, aes(x = time, y = index), color = "blue") +
  geom_line(data = pred_data, aes(x = real_index$time, y = pred_index), color = "red") +
  xlab("date") +
  ggtitle("prediction and real index of tsai in May")
```
